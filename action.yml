name: Install cosmocc
description: Install cosmocc on GitHub Actions
author: Brett Jia

inputs:
  version:
    description: Cosmopolitan release version
    required: true
    default: latest

runs:
  using: composite

  steps:
    - name: Download and extract
      shell: bash
      run: |
        RAND=$RANDOM
        INSTALL_DIR="${{ runner.temp }}/${RAND}"

        INSTALL_DIR_FORMATTED=${INSTALL_DIR}
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          INSTALL_DIR_FORMATTED=$(cygpath -w ${INSTALL_DIR})
        fi
        echo "Using install dir ${INSTALL_DIR}"

        mkdir -p ${INSTALL_DIR}
        cd ${INSTALL_DIR}

        VERSION="${{ inputs.version }}"
        if [[ "${VERSION}" == "latest" ]]; then
          VERSION=$(curl https://api.github.com/repos/jart/cosmopolitan/releases | jq -r .[0].tag_name)
        fi

        echo "Downloading cosmocc ${VERSION}"
        curl -s -S -f -L -o cosmocc.zip https://github.com/jart/cosmopolitan/releases/download/${VERSION}/cosmocc-${VERSION}.zip

        if [[ "${{ runner.os }}" == "Windows" ]]; then
          7z.exe x cosmocc.zip
          echo ${INSTALL_DIR_FORMATTED}\\cosmocc-${VERSION}\\bin >> $GITHUB_PATH
        else
          unzip cosmocc.zip
          echo ${INSTALL_DIR_FORMATTED}/cosmocc-${VERSION}/bin >> $GITHUB_PATH
        fi

    - name: Verify cosmocc version
      run: |
        cosmocc --version